name: Build and Release Mobile App

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º GitHub Release
  actions: write   # Actions æƒé™
  packages: write  # åŒ…æƒé™
  id-token: write  # ID token æƒé™

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          channel: 'stable'
          flutter-version-file: ./mobile/pubspec.yaml
          cache: true

      - name: Verify signing keys
        run: |
          if [ -z "${{ secrets.KEY_JKS }}" ] || [ -z "${{ secrets.ALIAS }}" ] || [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ] || [ -z "${{ secrets.ANDROID_STORE_PASSWORD }}" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦çš„ç­¾åå¯†é’¥é…ç½®"
            echo "è¯·ç¡®ä¿ä»¥ä¸‹ GitHub Secrets å·²é…ç½®ï¼š"
            echo "- KEY_JKS: ç­¾åè¯ä¹¦çš„ base64 ç¼–ç "
            echo "- ALIAS: è¯ä¹¦åˆ«å"
            echo "- ANDROID_KEY_PASSWORD: å¯†é’¥å¯†ç "
            echo "- ANDROID_STORE_PASSWORD: å­˜å‚¨å¯†ç "
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥é…ç½®å·²å°±ç»ª"

      - name: Create the Keystore
        env:
          KEY_JKS: ${{ secrets.KEY_JKS }}
        working-directory: ./mobile
        run: |
          echo "ğŸ”‘ è®¾ç½® Android ç­¾åè¯ä¹¦..."
          echo $KEY_JKS | base64 -d > android/key.jks
          echo "âœ… ç­¾åè¯ä¹¦è®¾ç½®å®Œæˆ"

      - name: Get Packages
        working-directory: ./mobile
        run: flutter pub get

      - name: Generate translation file
        run: make translation
        working-directory: ./mobile

      - name: Generate platform APIs
        run: make pigeon
        working-directory: ./mobile

      - name: Validate Signing Secrets
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          if [ -z "$ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ] || [ -z "$ANDROID_STORE_PASSWORD" ]; then
            echo "âŒ æ‰€æœ‰ç­¾åå¯†é’¥éƒ½æ˜¯å¿…éœ€çš„ (ALIAS, ANDROID_KEY_PASSWORD, ANDROID_STORE_PASSWORD)"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥éƒ½å¯ç”¨"

      - name: Build Signed Release APK
        working-directory: ./mobile
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "ğŸš€ å¼€å§‹æ„å»ºç­¾åçš„ Release APK..."
          flutter clean
          echo "æ„å»ºé€šç”¨ APK..."
          flutter build apk --release
          echo "æ„å»ºåˆ†æ¶æ„ APK..."
          flutter build apk --release --split-per-abi --target-platform android-arm,android-arm64,android-x64
          echo "âœ… APK æ„å»ºå®Œæˆ"

      - name: Verify APK Signature and Generate Checksums
        working-directory: ./mobile
        run: |
          echo "========================================="
          echo "ğŸ” APK ç­¾åéªŒè¯ä¸æ ¡éªŒç ç”Ÿæˆ"
          echo "========================================="
          
          # æŸ¥æ‰¾å¯ç”¨çš„ build-tools ç‰ˆæœ¬
          BUILD_TOOLS_VERSION=$(ls "$ANDROID_HOME/build-tools/" | sort -V | tail -1)
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          echo "ğŸ”§ Android Build Tools ç‰ˆæœ¬: $BUILD_TOOLS_VERSION"
          echo "ğŸ”§ apksigner è·¯å¾„: $APKSIGNER"
          
          # åˆ›å»ºæ ¡éªŒç æŠ¥å‘Šæ–‡ä»¶
          CHECKSUM_FILE="apk_checksums.txt"
          echo "APK æ ¡éªŒç ä¸ç­¾åéªŒè¯æŠ¥å‘Š" > "$CHECKSUM_FILE"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$CHECKSUM_FILE"
          echo "æ ‡ç­¾ç‰ˆæœ¬: ${{ github.ref_name }}" >> "$CHECKSUM_FILE"
          echo "æ„å»ºç¼–å·: ${{ github.run_id }}" >> "$CHECKSUM_FILE"
          echo "=========================================" >> "$CHECKSUM_FILE"
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              APK_NAME=$(basename "$apk")
              APK_SIZE=$(ls -lh "$apk" | awk '{print $5}')
              
              echo ""
              echo "ğŸ“± å¤„ç† APK: $APK_NAME"
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE"
              
              # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
              echo "" >> "$CHECKSUM_FILE"
              echo "ğŸ“± APK: $APK_NAME" >> "$CHECKSUM_FILE"
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE" >> "$CHECKSUM_FILE"
              
              # éªŒè¯ APK ç­¾å
              echo "ğŸ” éªŒè¯ APK ç­¾å..."
              
              # é¦–å…ˆå°è¯•ä½¿ç”¨ apksignerï¼ˆç›´æ¥æ‰§è¡Œï¼Œä¸ç”¨ java -jarï¼‰
              if command -v apksigner >/dev/null 2>&1; then
                if apksigner verify --verbose "$apk" 2>/dev/null; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ (apksigner)"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡ (apksigner)" >> "$CHECKSUM_FILE"
                else
                  echo "âš ï¸  apksigner éªŒè¯å¤±è´¥ï¼Œå°è¯• jarsigner..."
                  if jarsigner -verify -verbose "$apk" >/dev/null 2>&1; then
                    echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ (jarsigner)"
                    echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡ (jarsigner)" >> "$CHECKSUM_FILE"
                  else
                    echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥"  
                    echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥" >> "$CHECKSUM_FILE"
                  fi
                fi
              else
                echo "âš ï¸  apksigner æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ jarsigner éªŒè¯..."
                if jarsigner -verify -verbose "$apk" >/dev/null 2>&1; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ (jarsigner)"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡ (jarsigner)" >> "$CHECKSUM_FILE"
                else
                  echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥ (jarsigner)"  
                  echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥ (jarsigner)" >> "$CHECKSUM_FILE"
                fi
              fi
              
              # ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç 
              echo ""
              echo "ğŸ“Š ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç ..."
              
              MD5_HASH=$(md5 "$apk" 2>/dev/null | awk '{print $NF}' || md5sum "$apk" | awk '{print $1}')
              SHA1_HASH=$(shasum -a 1 "$apk" | awk '{print $1}')
              SHA256_HASH=$(shasum -a 256 "$apk" | awk '{print $1}')
              
              echo "ğŸ”¹ MD5:    $MD5_HASH"
              echo "ğŸ”¹ SHA1:   $SHA1_HASH" 
              echo "ğŸ”¹ SHA256: $SHA256_HASH"
              
              # å†™å…¥æ ¡éªŒç åˆ°æŠ¥å‘Šæ–‡ä»¶
              echo "ğŸ”¹ MD5:    $MD5_HASH" >> "$CHECKSUM_FILE"
              echo "ğŸ”¹ SHA1:   $SHA1_HASH" >> "$CHECKSUM_FILE"
              echo "ğŸ”¹ SHA256: $SHA256_HASH" >> "$CHECKSUM_FILE"
              
              echo "========================================="
            fi
          done
          
          echo ""
          echo "âœ… æ‰€æœ‰ APK å¤„ç†å®Œæˆ!"
          echo ""
          echo "ğŸ“„ å®Œæ•´æ ¡éªŒç æŠ¥å‘Š:"
          cat "$CHECKSUM_FILE"

      - name: Check GitHub Token Permissions
        run: |
          echo "ğŸ” æ£€æŸ¥ GitHub Token æƒé™..."
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"  
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "SHA: $GITHUB_SHA"
          
          # æµ‹è¯• API è®¿é—®æƒé™
          echo "ğŸ” æµ‹è¯• GitHub API è®¿é—®æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY" \
               -o /dev/null -s -w "%{http_code}")
          echo "API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… GitHub API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ GitHub API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi
          
          # æµ‹è¯• Releases API æƒé™
          echo "ğŸ” æµ‹è¯• Releases API æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
               -o /dev/null -s -w "%{http_code}")
          echo "Releases API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Releases API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ Releases API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi

      - name: Prepare Release Files
        working-directory: ./mobile
        run: |
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ../release-files
          
          # å¤åˆ¶ APK æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
          cp build/app/outputs/flutter-apk/*.apk ../release-files/
          
          # å¤åˆ¶æ ¡éªŒç æ–‡ä»¶
          cp apk_checksums.txt ../release-files/
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜æ–‡ä»¶
          echo "# Immich Mobile App Release ${{ github.ref_name }}" > ../release-files/RELEASE_NOTES.md
          echo "" >> ../release-files/RELEASE_NOTES.md
          echo "è¿™æ˜¯ Immich ç§»åŠ¨åº”ç”¨çš„æ­£å¼å‘å¸ƒç‰ˆæœ¬ã€‚" >> ../release-files/RELEASE_NOTES.md
          echo "" >> ../release-files/RELEASE_NOTES.md
          echo "**æ ‡ç­¾ç‰ˆæœ¬**: ${{ github.ref_name }}" >> ../release-files/RELEASE_NOTES.md
          echo "**æ„å»ºæ—¶é—´**: ${{ github.run_id }}" >> ../release-files/RELEASE_NOTES.md
          echo "**æäº¤å“ˆå¸Œ**: ${{ github.sha }}" >> ../release-files/RELEASE_NOTES.md
          echo "**æ„å»ºå¹³å°**: macOS-14" >> ../release-files/RELEASE_NOTES.md
          echo "" >> ../release-files/RELEASE_NOTES.md
          echo "## ğŸ“± APK æ–‡ä»¶" >> ../release-files/RELEASE_NOTES.md
          echo "" >> ../release-files/RELEASE_NOTES.md
          echo "è¯·ä¸‹è½½é€‚åˆä½ è®¾å¤‡æ¶æ„çš„ APK æ–‡ä»¶ï¼š" >> ../release-files/RELEASE_NOTES.md
          echo "" >> ../release-files/RELEASE_NOTES.md
          
          # åˆ—å‡ºæ‰€æœ‰ APK æ–‡ä»¶å¹¶æ·»åŠ åˆ°å‘å¸ƒè¯´æ˜
          cd ../release-files
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              apk_size=$(ls -lh "$apk" | awk '{print $5}')
              echo "- **$apk** ($apk_size)" >> RELEASE_NOTES.md
            fi
          done
          
          # æ·»åŠ å…¶ä½™è¯´æ˜
          echo "" >> RELEASE_NOTES.md
          echo "### æ¶æ„è¯´æ˜" >> RELEASE_NOTES.md
          echo "- \`app-release.apk\` - é€šç”¨ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æ¶æ„ï¼ˆæ¨èä¸‹è½½ï¼‰" >> RELEASE_NOTES.md
          echo "- \`app-arm64-v8a-release.apk\` - ARM64 è®¾å¤‡ä¸“ç”¨ï¼ˆç°ä»£ Android è®¾å¤‡ï¼‰" >> RELEASE_NOTES.md
          echo "- \`app-armeabi-v7a-release.apk\` - ARM 32ä½è®¾å¤‡ä¸“ç”¨ï¼ˆè¾ƒè€è®¾å¤‡ï¼‰" >> RELEASE_NOTES.md
          echo "- \`app-x86_64-release.apk\` - x86 64ä½è®¾å¤‡ä¸“ç”¨ï¼ˆæ¨¡æ‹Ÿå™¨æˆ–ç‰¹æ®Šè®¾å¤‡ï¼‰" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ” å®‰å…¨éªŒè¯" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "- ä¸‹è½½ \`apk_checksums.txt\` æ–‡ä»¶éªŒè¯ APK å®Œæ•´æ€§" >> RELEASE_NOTES.md
          echo "- æ‰€æœ‰ APK æ–‡ä»¶å‡å·²ä½¿ç”¨å‘å¸ƒè¯ä¹¦ç­¾åï¼Œç¡®ä¿å®‰å…¨å¯é " >> RELEASE_NOTES.md
          echo "- æ”¯æŒ MD5ã€SHA1ã€SHA256 å¤šç§æ ¡éªŒç®—æ³•" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ“‹ å®‰è£…è¯´æ˜" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "1. ä¸‹è½½é€‚åˆä½ è®¾å¤‡æ¶æ„çš„ APK æ–‡ä»¶ï¼ˆæ¨èä¸‹è½½é€šç”¨ç‰ˆæœ¬ï¼‰" >> RELEASE_NOTES.md
          echo "2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨\"æœªçŸ¥æ¥æº\"å®‰è£…ï¼š" >> RELEASE_NOTES.md
          echo "   - è®¾ç½® â†’ å®‰å…¨ â†’ æœªçŸ¥æ¥æºï¼ˆæˆ–åº”ç”¨å®‰è£…æƒé™ï¼‰" >> RELEASE_NOTES.md
          echo "3. ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨æ‰“å¼€ä¸‹è½½çš„ APK æ–‡ä»¶è¿›è¡Œå®‰è£…" >> RELEASE_NOTES.md
          echo "4. é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦æˆäºˆç›¸å…³æƒé™" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ”„ æ›´æ–°è¯´æ˜" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "- å¦‚æœå·²å®‰è£…æ—§ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¦†ç›–å®‰è£…" >> RELEASE_NOTES.md
          echo "- å»ºè®®åœ¨å®‰è£…å‰å¤‡ä»½é‡è¦æ•°æ®" >> RELEASE_NOTES.md
          echo "- æ”¯æŒä» Google Play ç‰ˆæœ¬å‡çº§åˆ°æ­¤ç‰ˆæœ¬" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## ğŸ› é—®é¢˜åé¦ˆ" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆã€‚" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "## æºç ä¿¡æ¯" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md
          echo "- åŸºäºæäº¤: ${{ github.sha }}" >> RELEASE_NOTES.md
          echo "- æ„å»ºåˆ†æ”¯: ${{ github.ref_name }}" >> RELEASE_NOTES.md
          echo "- Flutter ç‰ˆæœ¬: Stable Channel" >> RELEASE_NOTES.md
          echo "- ç­¾åçŠ¶æ€: å·²ç­¾å" >> RELEASE_NOTES.md
          
          echo ""
          echo "ğŸ“‹ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la
          echo ""
          echo "ğŸ“„ æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h *

      - name: Debug Release Files
        run: |
          echo "ğŸ” è°ƒè¯•å‘å¸ƒæ–‡ä»¶ä¿¡æ¯..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ ‡ç­¾åç§°: ${{ github.ref_name }}"
          echo "æ˜¯å¦é¢„å‘å¸ƒ: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}"
          
          echo ""
          echo "ğŸ“‹ å‘å¸ƒæ–‡ä»¶è¯¦æƒ…:"
          ls -la release-files/
          
          echo ""
          echo "ğŸ“„ å‘å¸ƒè¯´æ˜å†…å®¹é¢„è§ˆ:"
          head -30 release-files/RELEASE_NOTES.md
          
          echo ""
          echo "ğŸ” æ ¡éªŒç æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -20 release-files/apk_checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "Immich Mobile ${{ github.ref_name }}"
          body_path: release-files/RELEASE_NOTES.md
          files: |
            release-files/*.apk
            release-files/apk_checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          fail_on_unmatched_files: false 
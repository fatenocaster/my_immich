name: Release Android APK

on:
  workflow_dispatch:  # ä¿ç•™æ‰‹åŠ¨è§¦å‘ç”¨äºæµ‹è¯•
  push:
    tags:
      - 'v*'  # åªåœ¨æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘æ„å»º

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º GitHub Release
  actions: write   # Actions æƒé™
  packages: write  # åŒ…æƒé™
  id-token: write  # ID token æƒé™

jobs:
  pre-job:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      should_run: ${{ steps.check_conditions.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false

      - name: Check run conditions
        id: check_conditions
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          
          # åªåœ¨æ ‡ç­¾æ¨é€æˆ–æ‰‹åŠ¨è§¦å‘æ—¶è¿è¡Œ
          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Tag push or manual trigger detected, will run build"
            echo "should_run=true" >> "$GITHUB_OUTPUT"
          else
            echo "Not a tag push or manual trigger, skipping build"
            echo "should_run=false" >> "$GITHUB_OUTPUT"
          fi

  build-sign-android:
    name: Build, Sign and Release Android APK
    needs: pre-job
    permissions:
      contents: read
    if: ${{ github.actor != 'dependabot[bot]' && needs.pre-job.outputs.should_run == 'true' }}
    runs-on: macos-14

    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.ref || github.sha }}
          persist-credentials: false

      - uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          channel: 'stable'
          flutter-version-file: ./mobile/pubspec.yaml
          cache: true

      - name: Create the Keystore
        env:
          KEY_JKS: ${{ secrets.KEY_JKS }}
        working-directory: ./mobile
        run: |
          if [ -z "$KEY_JKS" ]; then
            echo "Error: KEY_JKS secret is required for release build"
            exit 1
          fi
          echo "Creating keystore for signed release build"
          echo $KEY_JKS | base64 -d > android/key.jks

      - name: Get Packages
        working-directory: ./mobile
        run: flutter pub get

      - name: Generate translation file
        run: make translation
        working-directory: ./mobile

      - name: Generate platform APIs
        run: make pigeon
        working-directory: ./mobile

      - name: Validate Signing Secrets
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          if [ -z "$ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ] || [ -z "$ANDROID_STORE_PASSWORD" ]; then
            echo "Error: All signing secrets are required (ALIAS, ANDROID_KEY_PASSWORD, ANDROID_STORE_PASSWORD)"
            exit 1
          fi
          echo "All signing secrets are available"

      - name: Build Signed Release APK
        working-directory: ./mobile
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "Building signed release APK..."
          flutter build apk --release
          echo "Building signed release APK with ABI splits..."
          flutter build apk --release --split-per-abi --target-platform android-arm,android-arm64,android-x64

      - name: Verify APK Signature and Generate Checksums
        working-directory: ./mobile
        run: |
          echo "========================================="
          echo "ğŸ” APK ç­¾åéªŒè¯ä¸æ ¡éªŒç ç”Ÿæˆ"
          echo "========================================="
          
          # æŸ¥æ‰¾å¯ç”¨çš„ build-tools ç‰ˆæœ¬
          BUILD_TOOLS_VERSION=$(ls "$ANDROID_HOME/build-tools/" | sort -V | tail -1)
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          echo "ğŸ”§ Android Build Tools ç‰ˆæœ¬: $BUILD_TOOLS_VERSION"
          echo "ğŸ”§ apksigner è·¯å¾„: $APKSIGNER"
          
          # åˆ›å»ºæ ¡éªŒç æŠ¥å‘Šæ–‡ä»¶
          CHECKSUM_FILE="apk_checksums.txt"
          echo "APK æ ¡éªŒç ä¸ç­¾åéªŒè¯æŠ¥å‘Š" > "$CHECKSUM_FILE"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$CHECKSUM_FILE"
          echo "=========================================" >> "$CHECKSUM_FILE"
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              APK_NAME=$(basename "$apk")
              APK_SIZE=$(ls -lh "$apk" | awk '{print $5}')
              
              echo ""
              echo "ğŸ“± å¤„ç† APK: $APK_NAME"
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE"
              
              # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
              echo "" >> "$CHECKSUM_FILE"
              echo "ğŸ“± APK: $APK_NAME" >> "$CHECKSUM_FILE"
              echo "ğŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE" >> "$CHECKSUM_FILE"
              
              # éªŒè¯ APK ç­¾å
              echo "ğŸ” éªŒè¯ APK ç­¾å..."
              if [ -f "$APKSIGNER" ]; then
                # ä½¿ç”¨æ­£ç¡®çš„ apksigner å‘½ä»¤æ ¼å¼
                if java -jar "$APKSIGNER" verify --verbose "$apk"; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡" >> "$CHECKSUM_FILE"
                else
                  echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥"
                  echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥" >> "$CHECKSUM_FILE"
                fi
              else
                echo "âš ï¸  apksigner æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ jarsigner éªŒè¯..."
                if jarsigner -verify -verbose "$apk" >/dev/null 2>&1; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ (jarsigner)"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡ (jarsigner)" >> "$CHECKSUM_FILE"
                else
                  echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥ (jarsigner)"  
                  echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥ (jarsigner)" >> "$CHECKSUM_FILE"
                fi
              fi
              
              # ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç 
              echo ""
              echo "ğŸ“Š ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç ..."
              
              MD5_HASH=$(md5 "$apk" 2>/dev/null | awk '{print $NF}' || md5sum "$apk" | awk '{print $1}')
              SHA1_HASH=$(shasum -a 1 "$apk" | awk '{print $1}')
              SHA256_HASH=$(shasum -a 256 "$apk" | awk '{print $1}')
              
              echo "ğŸ”¹ MD5:    $MD5_HASH"
              echo "ğŸ”¹ SHA1:   $SHA1_HASH" 
              echo "ğŸ”¹ SHA256: $SHA256_HASH"
              
              # å†™å…¥æ ¡éªŒç åˆ°æŠ¥å‘Šæ–‡ä»¶
              echo "ğŸ”¹ MD5:    $MD5_HASH" >> "$CHECKSUM_FILE"
              echo "ğŸ”¹ SHA1:   $SHA1_HASH" >> "$CHECKSUM_FILE"
              echo "ğŸ”¹ SHA256: $SHA256_HASH" >> "$CHECKSUM_FILE"
              
              echo "========================================="
            fi
          done
          
          echo ""
          echo "âœ… æ‰€æœ‰ APK å¤„ç†å®Œæˆ!"
          echo ""
          echo "ğŸ“„ å®Œæ•´æ ¡éªŒç æŠ¥å‘Š:"
          cat "$CHECKSUM_FILE"

      - name: Check GitHub Token Permissions
        run: |
          echo "ğŸ” æ£€æŸ¥ GitHub Token æƒé™..."
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"  
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          
          # æµ‹è¯• API è®¿é—®æƒé™
          curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY" \
               -o /dev/null -s -w "API Status: %{http_code}\n"

      - name: Prepare Release Files
        run: |
          echo "ğŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          
          # åˆ›å»ºæ ¹ç›®å½•çš„å‘å¸ƒç›®å½•ï¼ˆå‚è€ƒä½ æˆåŠŸçš„é¡¹ç›®ï¼‰
          mkdir -p release-files
          
          # å¤åˆ¶ APK æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
          cp mobile/build/app/outputs/flutter-apk/*.apk release-files/ 2>/dev/null || echo "No APK files found"
          
          # å¤åˆ¶æ ¡éªŒç æ–‡ä»¶
          cp mobile/apk_checksums.txt release-files/ 2>/dev/null || echo "No checksum file found"
          
          echo "ğŸ“‹ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la release-files/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Immich Mobile ${{ github.ref_name }}
          body: |
            ## Immich Mobile App Release ${{ github.ref_name }}
            
            è¿™æ˜¯ Immich ç§»åŠ¨åº”ç”¨çš„å‘å¸ƒç‰ˆæœ¬ã€‚
            
            **æ ‡ç­¾ç‰ˆæœ¬**: ${{ github.ref_name }}
            **æ„å»ºæ—¶é—´**: ${{ github.run_id }}
            **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
            
            ### ğŸ“± APK æ–‡ä»¶
            
            è¯·ä¸‹è½½é€‚åˆä½ è®¾å¤‡æ¶æ„çš„ APK æ–‡ä»¶ï¼š
            - `app-release.apk` - é€šç”¨ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
            - `app-arm64-v8a-release.apk` - ARM64 è®¾å¤‡
            - `app-armeabi-v7a-release.apk` - ARM 32ä½è®¾å¤‡  
            - `app-x86_64-release.apk` - x86 64ä½è®¾å¤‡
            
            ### ğŸ” å®‰å…¨éªŒè¯
            
            - ä¸‹è½½ `apk_checksums.txt` æ–‡ä»¶éªŒè¯ APK å®Œæ•´æ€§
            - æ‰€æœ‰ APK æ–‡ä»¶å‡å·²ç­¾åï¼Œç¡®ä¿å®‰å…¨å¯é 
            
            ### ğŸ“‹ å®‰è£…è¯´æ˜
            
            1. ä¸‹è½½é€‚åˆä½ è®¾å¤‡æ¶æ„çš„ APK æ–‡ä»¶
            2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
            3. å®‰è£…ä¸‹è½½çš„ APK æ–‡ä»¶
            
            ### æºç 
            åŸºäºæäº¤: ${{ github.sha }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          files: release-files/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
name: Build and Release Mobile App (Test Version)

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ³¨é‡ŠæŽ‰æ‰€æœ‰ç¼–è¯‘ç›¸å…³æ­¥éª¤ï¼Œåªæµ‹è¯• Release åŠŸèƒ½
      # - name: Setup Java
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: 'zulu'
      #     java-version: '17'

      # - name: Setup Flutter
      #   uses: subosito/flutter-action@v2
      #   with:
      #     flutter-version: '3.29.3'
      #     channel: 'stable'
      #     cache: true

      # - name: Verify signing keys
      #   run: |
      #     if [ -z "${{ secrets.KEY_JKS }}" ] || [ -z "${{ secrets.ALIAS }}" ] || [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ] || [ -z "${{ secrets.ANDROID_STORE_PASSWORD }}" ]; then
      #       echo "âŒ ç¼ºå°‘å¿…è¦çš„ç­¾åå¯†é’¥é…ç½®"
      #       echo "è¯·ç¡®ä¿ä»¥ä¸‹ GitHub Secrets å·²é…ç½®ï¼š"
      #       echo "- KEY_JKS: ç­¾åè¯ä¹¦çš„ base64 ç¼–ç "
      #       echo "- ALIAS: è¯ä¹¦åˆ«å"
      #       echo "- ANDROID_KEY_PASSWORD: å¯†é’¥å¯†ç "
      #       echo "- ANDROID_STORE_PASSWORD: å­˜å‚¨å¯†ç "
      #       exit 1
      #     fi
      #     echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥é…ç½®å·²å°±ç»ª"

      # - name: Setup signing certificate
      #   run: |
      #     echo "ðŸ”‘ è®¾ç½® Android ç­¾åè¯ä¹¦..."
      #     echo "${{ secrets.KEY_JKS }}" | base64 --decode > mobile/android/app-release-key.jks
      #     echo "âœ… ç­¾åè¯ä¹¦è®¾ç½®å®Œæˆ"

      # - name: Create key.properties
      #   run: |
      #     echo "ðŸ“ åˆ›å»º key.properties æ–‡ä»¶..."
      #     cat > mobile/android/key.properties << EOF
      #     storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
      #     keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
      #     keyAlias=${{ secrets.ALIAS }}
      #     storeFile=app-release-key.jks
      #     EOF
      #     echo "âœ… key.properties åˆ›å»ºå®Œæˆ"

      # - name: Build APK
      #   working-directory: mobile
      #   run: |
      #     echo "ðŸš€ å¼€å§‹æž„å»º Android APK..."
      #     flutter clean
      #     flutter pub get
      #     flutter build apk --release --split-per-abi
      #     echo "âœ… APK æž„å»ºå®Œæˆ"

      # - name: Verify APK signature
      #   working-directory: mobile
      #   run: |
      #     echo "ðŸ” éªŒè¯ APK ç­¾å..."
      #     APK_PATH="build/app/outputs/flutter-apk"
      #     for apk in $APK_PATH/*.apk; do
      #       if [ -f "$apk" ]; then
      #         echo "æ£€æŸ¥: $(basename "$apk")"
      #         if command -v apksigner >/dev/null 2>&1; then
      #           java -jar $ANDROID_HOME/build-tools/*/lib/apksigner.jar verify --verbose "$apk" || echo "apksigner éªŒè¯å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•"
      #         fi
      #         jarsigner -verify -verbose -certs "$apk" && echo "âœ… $(basename "$apk") ç­¾åéªŒè¯é€šè¿‡" || echo "âŒ $(basename "$apk") ç­¾åéªŒè¯å¤±è´¥"
      #       fi
      #     done

      - name: Create test release files
        run: |
          echo "ðŸ“¦ åˆ›å»ºæµ‹è¯•æ–‡ä»¶ç”¨äºŽ Release..."
          mkdir -p release-files
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„ APK æ–‡ä»¶
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - é€šç”¨ç‰ˆæœ¬" > release-files/app-release.apk
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - ARM64 ç‰ˆæœ¬" > release-files/app-arm64-v8a-release.apk
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - ARM32 ç‰ˆæœ¬" > release-files/app-armeabi-v7a-release.apk
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - x86_64 ç‰ˆæœ¬" > release-files/app-x86_64-release.apk
          
          # åˆ›å»ºæ ¡éªŒç æ–‡ä»¶
          cat > release-files/apk_checksums.txt << EOF
          # APK æ–‡ä»¶æ ¡éªŒç  (æµ‹è¯•ç‰ˆæœ¬)
          # ç”Ÿæˆæ—¶é—´: $(date)
          # æ ‡ç­¾ç‰ˆæœ¬: ${{ github.ref_name }}
          
          ## MD5 æ ¡éªŒç 
          $(md5sum release-files/*.apk | sed 's|release-files/||')
          
          ## SHA1 æ ¡éªŒç   
          $(sha1sum release-files/*.apk | sed 's|release-files/||')
          
          ## SHA256 æ ¡éªŒç 
          $(sha256sum release-files/*.apk | sed 's|release-files/||')
          EOF
          
          echo "ðŸ“‹ æµ‹è¯•æ–‡ä»¶åˆ—è¡¨:"
          ls -la release-files/

      - name: Create GitHub Release with GitHub CLI
        run: |
          echo "ðŸš€ ä½¿ç”¨ GitHub CLI åˆ›å»º Release..."
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Ž
          RELEASE_BODY="## Immich Mobile App Release ${{ github.ref_name }} (æµ‹è¯•ç‰ˆæœ¬)

          è¿™æ˜¯ Immich ç§»åŠ¨åº”ç”¨çš„æµ‹è¯•å‘å¸ƒç‰ˆæœ¬ã€‚

          **æ ‡ç­¾ç‰ˆæœ¬**: ${{ github.ref_name }}
          **æž„å»ºæ—¶é—´**: ${{ github.run_id }}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}

          ### ðŸ“± APK æ–‡ä»¶ (æµ‹è¯•æ–‡ä»¶)

          è¯·ä¸‹è½½é€‚åˆä½ è®¾å¤‡æž¶æž„çš„ APK æ–‡ä»¶ï¼š
          - \`app-release.apk\` - é€šç”¨ç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          - \`app-arm64-v8a-release.apk\` - ARM64 è®¾å¤‡
          - \`app-armeabi-v7a-release.apk\` - ARM 32ä½è®¾å¤‡  
          - \`app-x86_64-release.apk\` - x86 64ä½è®¾å¤‡

          ### ðŸ” å®‰å…¨éªŒè¯

          - ä¸‹è½½ \`apk_checksums.txt\` æ–‡ä»¶éªŒè¯ APK å®Œæ•´æ€§
          - æ‰€æœ‰ APK æ–‡ä»¶å‡å·²ç­¾åï¼Œç¡®ä¿å®‰å…¨å¯é 

          ### ðŸ“‹ å®‰è£…è¯´æ˜Ž

          âš ï¸ **æ³¨æ„ï¼šè¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼ŒåŒ…å«çš„æ˜¯æµ‹è¯•æ–‡ä»¶ï¼Œä¸æ˜¯çœŸå®žçš„ APKï¼**

          ### æºç 
          åŸºäºŽæäº¤: ${{ github.sha }}"
          
          # æ£€æŸ¥æ˜¯å¦æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬
          if [[ "${{ github.ref_name }}" == *"beta"* ]] || [[ "${{ github.ref_name }}" == *"alpha"* ]] || [[ "${{ github.ref_name }}" == *"rc"* ]]; then
            PRERELEASE_FLAG="--prerelease"
          else
            PRERELEASE_FLAG=""
          fi
          
          # å°è¯•ä½¿ç”¨ gh CLI åˆ›å»º release
          echo "ðŸ“ Release å†…å®¹é¢„è§ˆ:"
          echo "æ ‡ç­¾: ${{ github.ref_name }}"
          echo "æ–‡ä»¶æ•°é‡: $(ls -1 release-files/ | wc -l)"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la release-files/
          
          if gh release create "${{ github.ref_name }}" \
            --title "Immich Mobile ${{ github.ref_name }} (æµ‹è¯•)" \
            --notes "$RELEASE_BODY" \
            $PRERELEASE_FLAG \
            release-files/*; then
            echo "âœ… GitHub CLI Release åˆ›å»ºæˆåŠŸ!"
          else
            echo "âŒ GitHub CLI å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ curl API..."
            
            # å¤‡ç”¨æ–¹æ¡ˆï¼šä½¿ç”¨ curl ç›´æŽ¥è°ƒç”¨ GitHub API
            echo "ðŸ”„ ä½¿ç”¨ curl åˆ›å»º Release..."
            
            # æž„å»º JSON æ•°æ®
            PRERELEASE_BOOL="false"
            if [[ "${{ github.ref_name }}" == *"beta"* ]] || [[ "${{ github.ref_name }}" == *"alpha"* ]] || [[ "${{ github.ref_name }}" == *"rc"* ]]; then
              PRERELEASE_BOOL="true"
            fi
            
            # åˆ›å»º Release
            RELEASE_RESPONSE=$(curl -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases" \
              -d "{
                \"tag_name\": \"${{ github.ref_name }}\",
                \"name\": \"Immich Mobile ${{ github.ref_name }} (æµ‹è¯•)\",
                \"body\": \"$RELEASE_BODY\",
                \"draft\": false,
                \"prerelease\": $PRERELEASE_BOOL
              }")
            
            RELEASE_ID=$(echo "$RELEASE_RESPONSE" | jq -r '.id // empty')
            
            if [ -n "$RELEASE_ID" ]; then
              echo "âœ… Release åˆ›å»ºæˆåŠŸ (ID: $RELEASE_ID)"
              
              # ä¸Šä¼ æ–‡ä»¶
              for file in release-files/*; do
                if [ -f "$file" ]; then
                  filename=$(basename "$file")
                  echo "ðŸ“¤ ä¸Šä¼ : $filename"
                  
                  curl -X POST \
                    -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                    -H "Content-Type: application/octet-stream" \
                    --data-binary @"$file" \
                    "https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$filename"
                  
                  echo "âœ… $filename ä¸Šä¼ å®Œæˆ"
                fi
              done
            else
              echo "âŒ Release åˆ›å»ºå¤±è´¥"
              echo "API å“åº”: $RELEASE_RESPONSE"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
name: Build and Release Mobile App (Test Version)

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º GitHub Release
  actions: write   # Actions æƒé™
  packages: write  # åŒ…æƒé™
  id-token: write  # ID token æƒé™

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # æ³¨é‡ŠæŽ‰æ‰€æœ‰ç¼–è¯‘ç›¸å…³æ­¥éª¤ï¼Œåªæµ‹è¯• Release åŠŸèƒ½
      # - name: Setup Java
      #   uses: actions/setup-java@v4
      #   with:
      #     distribution: 'zulu'
      #     java-version: '17'

      # - name: Setup Flutter
      #   uses: subosito/flutter-action@v2
      #   with:
      #     flutter-version: '3.29.3'
      #     channel: 'stable'
      #     cache: true

      # - name: Verify signing keys
      #   run: |
      #     if [ -z "${{ secrets.KEY_JKS }}" ] || [ -z "${{ secrets.ALIAS }}" ] || [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ] || [ -z "${{ secrets.ANDROID_STORE_PASSWORD }}" ]; then
      #       echo "âŒ ç¼ºå°‘å¿…è¦çš„ç­¾åå¯†é’¥é…ç½®"
      #       echo "è¯·ç¡®ä¿ä»¥ä¸‹ GitHub Secrets å·²é…ç½®ï¼š"
      #       echo "- KEY_JKS: ç­¾åè¯ä¹¦çš„ base64 ç¼–ç "
      #       echo "- ALIAS: è¯ä¹¦åˆ«å"
      #       echo "- ANDROID_KEY_PASSWORD: å¯†é’¥å¯†ç "
      #       echo "- ANDROID_STORE_PASSWORD: å­˜å‚¨å¯†ç "
      #       exit 1
      #     fi
      #     echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥é…ç½®å·²å°±ç»ª"

      # - name: Setup signing certificate
      #   run: |
      #     echo "ðŸ”‘ è®¾ç½® Android ç­¾åè¯ä¹¦..."
      #     echo "${{ secrets.KEY_JKS }}" | base64 --decode > mobile/android/app-release-key.jks
      #     echo "âœ… ç­¾åè¯ä¹¦è®¾ç½®å®Œæˆ"

      # - name: Create key.properties
      #   run: |
      #     echo "ðŸ“ åˆ›å»º key.properties æ–‡ä»¶..."
      #     cat > mobile/android/key.properties << EOF
      #     storePassword=${{ secrets.ANDROID_STORE_PASSWORD }}
      #     keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
      #     keyAlias=${{ secrets.ALIAS }}
      #     storeFile=app-release-key.jks
      #     EOF
      #     echo "âœ… key.properties åˆ›å»ºå®Œæˆ"

      # - name: Build APK
      #   working-directory: mobile
      #   run: |
      #     echo "ðŸš€ å¼€å§‹æž„å»º Android APK..."
      #     flutter clean
      #     flutter pub get
      #     flutter build apk --release --split-per-abi
      #     echo "âœ… APK æž„å»ºå®Œæˆ"

      # - name: Verify APK signature
      #   working-directory: mobile
      #   run: |
      #     echo "ðŸ” éªŒè¯ APK ç­¾å..."
      #     APK_PATH="build/app/outputs/flutter-apk"
      #     for apk in $APK_PATH/*.apk; do
      #       if [ -f "$apk" ]; then
      #         echo "æ£€æŸ¥: $(basename "$apk")"
      #         if command -v apksigner >/dev/null 2>&1; then
      #           java -jar $ANDROID_HOME/build-tools/*/lib/apksigner.jar verify --verbose "$apk" || echo "apksigner éªŒè¯å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ³•"
      #         fi
      #         jarsigner -verify -verbose -certs "$apk" && echo "âœ… $(basename "$apk") ç­¾åéªŒè¯é€šè¿‡" || echo "âŒ $(basename "$apk") ç­¾åéªŒè¯å¤±è´¥"
      #       fi
      #     done

      - name: Check GitHub Token Permissions
        run: |
          echo "ðŸ” æ£€æŸ¥ GitHub Token æƒé™..."
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"  
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "SHA: $GITHUB_SHA"
          
          # æµ‹è¯• API è®¿é—®æƒé™
          echo "ðŸ” æµ‹è¯• GitHub API è®¿é—®æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY" \
               -o /dev/null -s -w "%{http_code}")
          echo "API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… GitHub API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ GitHub API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi
          
          # æµ‹è¯• Releases API æƒé™
          echo "ðŸ” æµ‹è¯• Releases API æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
               -o /dev/null -s -w "%{http_code}")
          echo "Releases API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Releases API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ Releases API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi

      - name: Create test release files
        run: |
          echo "ðŸ“¦ åˆ›å»ºæµ‹è¯•æ–‡ä»¶ç”¨äºŽ Release..."
          mkdir -p release-files
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„ APK æ–‡ä»¶ (ç¨å¤§ä¸€äº›ï¼Œæ¨¡æ‹ŸçœŸå®žAPK)
          dd if=/dev/zero of=release-files/app-release.apk bs=1024 count=1024 2>/dev/null
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - é€šç”¨ç‰ˆæœ¬" >> release-files/app-release.apk
          
          dd if=/dev/zero of=release-files/app-arm64-v8a-release.apk bs=1024 count=800 2>/dev/null
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - ARM64 ç‰ˆæœ¬" >> release-files/app-arm64-v8a-release.apk
          
          dd if=/dev/zero of=release-files/app-armeabi-v7a-release.apk bs=1024 count=900 2>/dev/null
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - ARM32 ç‰ˆæœ¬" >> release-files/app-armeabi-v7a-release.apk
          
          dd if=/dev/zero of=release-files/app-x86_64-release.apk bs=1024 count=1100 2>/dev/null
          echo "è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• APK æ–‡ä»¶ - x86_64 ç‰ˆæœ¬" >> release-files/app-x86_64-release.apk
          
          # åˆ›å»ºæ ¡éªŒç æ–‡ä»¶
          cat > release-files/apk_checksums.txt << EOF
          # APK æ–‡ä»¶æ ¡éªŒç  (æµ‹è¯•ç‰ˆæœ¬)
          # ç”Ÿæˆæ—¶é—´: $(date)
          # æ ‡ç­¾ç‰ˆæœ¬: ${{ github.ref_name }}
          # æž„å»ºç¼–å·: ${{ github.run_id }}
          
          ## MD5 æ ¡éªŒç 
          $(md5sum release-files/*.apk | sed 's|release-files/||')
          
          ## SHA1 æ ¡éªŒç   
          $(sha1sum release-files/*.apk | sed 's|release-files/||')
          
          ## SHA256 æ ¡éªŒç 
          $(sha256sum release-files/*.apk | sed 's|release-files/||')
          EOF
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
          cat > release-files/RELEASE_NOTES.md << EOF
          # Immich Mobile App Release ${{ github.ref_name }} (æµ‹è¯•ç‰ˆæœ¬)
          
          âš ï¸ **è¿™æ˜¯æµ‹è¯•ç‰ˆæœ¬ï¼ŒåŒ…å«çš„æ˜¯æµ‹è¯•æ–‡ä»¶ï¼Œä¸æ˜¯çœŸå®žçš„ APKï¼**
          
          **æ ‡ç­¾ç‰ˆæœ¬**: ${{ github.ref_name }}
          **æž„å»ºæ—¶é—´**: ${{ github.run_id }}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          
          ## ðŸ“± APK æ–‡ä»¶ (æµ‹è¯•æ–‡ä»¶)
          
          è¯·ä¸‹è½½é€‚åˆä½ è®¾å¤‡æž¶æž„çš„ APK æ–‡ä»¶ï¼š
          - \`app-release.apk\` - é€šç”¨ç‰ˆæœ¬ï¼ˆæŽ¨èï¼‰
          - \`app-arm64-v8a-release.apk\` - ARM64 è®¾å¤‡
          - \`app-armeabi-v7a-release.apk\` - ARM 32ä½è®¾å¤‡  
          - \`app-x86_64-release.apk\` - x86 64ä½è®¾å¤‡
          
          ## ðŸ” å®‰å…¨éªŒè¯
          
          - ä¸‹è½½ \`apk_checksums.txt\` æ–‡ä»¶éªŒè¯ APK å®Œæ•´æ€§
          - æµ‹è¯•æ–‡ä»¶å·²åŒ…å«æ ¡éªŒç 
          
          ## ðŸ“‹ æµ‹è¯•è¯´æ˜Ž
          
          è¿™æ˜¯ç”¨äºŽæµ‹è¯• GitHub Actions Release åŠŸèƒ½çš„ç‰ˆæœ¬ã€‚
          æ–‡ä»¶å†…å®¹ä¸ºæµ‹è¯•æ•°æ®ï¼Œè¯·å‹¿ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒã€‚
          
          ## æºç 
          åŸºäºŽæäº¤: ${{ github.sha }}
          EOF
          
          echo "ðŸ“‹ æµ‹è¯•æ–‡ä»¶åˆ—è¡¨:"
          ls -la release-files/
          echo ""
          echo "ðŸ“„ æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h release-files/*

      - name: Debug Release Files
        run: |
          echo "ðŸ” è°ƒè¯•å‘å¸ƒæ–‡ä»¶ä¿¡æ¯..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ ‡ç­¾åç§°: ${{ github.ref_name }}"
          echo "æ˜¯å¦é¢„å‘å¸ƒ: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}"
          
          echo ""
          echo "ðŸ“‹ å‘å¸ƒæ–‡ä»¶è¯¦æƒ…:"
          ls -la release-files/
          
          echo ""
          echo "ðŸ“„ å‘å¸ƒè¯´æ˜Žå†…å®¹:"
          cat release-files/RELEASE_NOTES.md
          
          echo ""
          echo "ðŸ” æ ¡éªŒç æ–‡ä»¶å†…å®¹:"
          head -20 release-files/apk_checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "Immich Mobile ${{ github.ref_name }} (æµ‹è¯•ç‰ˆæœ¬)"
          body_path: release-files/RELEASE_NOTES.md
          files: |
            release-files/*.apk
            release-files/apk_checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          fail_on_unmatched_files: false 
name: Build and Release Mobile App

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»º GitHub Release
  actions: write   # Actions æƒé™
  packages: write  # åŒ…æƒé™
  id-token: write  # ID token æƒé™

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4.7.1
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter SDK
        uses: subosito/flutter-action@e938fdf56512cc96ef2f93601a5a40bde3801046 # v2.19.0
        with:
          channel: 'stable'
          flutter-version-file: ./mobile/pubspec.yaml
          cache: true

      - name: Verify signing keys
        run: |
          if [ -z "${{ secrets.KEY_JKS }}" ] || [ -z "${{ secrets.ALIAS }}" ] || [ -z "${{ secrets.ANDROID_KEY_PASSWORD }}" ] || [ -z "${{ secrets.ANDROID_STORE_PASSWORD }}" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦çš„ç­¾åå¯†é’¥é…ç½®"
            echo "è¯·ç¡®ä¿ä»¥ä¸‹ GitHub Secrets å·²é…ç½®ï¼š"
            echo "- KEY_JKS: ç­¾åè¯ä¹¦çš„ base64 ç¼–ç "
            echo "- ALIAS: è¯ä¹¦åˆ«å"
            echo "- ANDROID_KEY_PASSWORD: å¯†é’¥å¯†ç "
            echo "- ANDROID_STORE_PASSWORD: å­˜å‚¨å¯†ç "
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥é…ç½®å·²å°±ç»ª"

      - name: Create the Keystore
        env:
          KEY_JKS: ${{ secrets.KEY_JKS }}
        working-directory: ./mobile
        run: |
          echo "ðŸ”‘ è®¾ç½® Android ç­¾åè¯ä¹¦..."
          echo $KEY_JKS | base64 -d > android/key.jks
          echo "âœ… ç­¾åè¯ä¹¦è®¾ç½®å®Œæˆ"

      - name: Get Packages
        working-directory: ./mobile
        run: flutter pub get

      - name: Generate translation file
        run: make translation
        working-directory: ./mobile

      - name: Generate platform APIs
        run: make pigeon
        working-directory: ./mobile

      - name: Validate Signing Secrets
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          if [ -z "$ALIAS" ] || [ -z "$ANDROID_KEY_PASSWORD" ] || [ -z "$ANDROID_STORE_PASSWORD" ]; then
            echo "âŒ æ‰€æœ‰ç­¾åå¯†é’¥éƒ½æ˜¯å¿…éœ€çš„ (ALIAS, ANDROID_KEY_PASSWORD, ANDROID_STORE_PASSWORD)"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰ç­¾åå¯†é’¥éƒ½å¯ç”¨"

      - name: Build Signed Release APK
        working-directory: ./mobile
        env:
          ALIAS: ${{ secrets.ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
          ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
        run: |
          echo "ðŸš€ å¼€å§‹æž„å»ºç­¾åçš„ Release APK..."
          flutter clean
          echo "æž„å»ºé€šç”¨ APK..."
          flutter build apk --release
          echo "æž„å»ºåˆ†æž¶æž„ APK..."
          flutter build apk --release --split-per-abi --target-platform android-arm,android-arm64,android-x64
          echo "âœ… APK æž„å»ºå®Œæˆ"

      - name: Verify APK Signature and Generate Checksums
        working-directory: ./mobile
        run: |
          echo "========================================="
          echo "ðŸ” APK ç­¾åéªŒè¯ä¸Žæ ¡éªŒç ç”Ÿæˆ"
          echo "========================================="
          
          # æŸ¥æ‰¾å¯ç”¨çš„ build-tools ç‰ˆæœ¬
          BUILD_TOOLS_VERSION=$(ls "$ANDROID_HOME/build-tools/" | sort -V | tail -1)
          APKSIGNER="$ANDROID_HOME/build-tools/$BUILD_TOOLS_VERSION/apksigner"
          
          echo "ðŸ”§ Android Build Tools ç‰ˆæœ¬: $BUILD_TOOLS_VERSION"
          echo "ðŸ”§ apksigner è·¯å¾„: $APKSIGNER"
          
          # åˆ›å»ºæ ¡éªŒç æŠ¥å‘Šæ–‡ä»¶
          CHECKSUM_FILE="apk_checksums.txt"
          echo "APK æ ¡éªŒç ä¸Žç­¾åéªŒè¯æŠ¥å‘Š" > "$CHECKSUM_FILE"
          echo "ç”Ÿæˆæ—¶é—´: $(date)" >> "$CHECKSUM_FILE"
          echo "æ ‡ç­¾ç‰ˆæœ¬: ${{ github.ref_name }}" >> "$CHECKSUM_FILE"
          echo "æž„å»ºç¼–å·: ${{ github.run_id }}" >> "$CHECKSUM_FILE"
          echo "=========================================" >> "$CHECKSUM_FILE"
          
          for apk in build/app/outputs/flutter-apk/*.apk; do
            if [ -f "$apk" ]; then
              APK_NAME=$(basename "$apk")
              APK_SIZE=$(ls -lh "$apk" | awk '{print $5}')
              
              echo ""
              echo "ðŸ“± å¤„ç† APK: $APK_NAME"
              echo "ðŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE"
              
              # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
              echo "" >> "$CHECKSUM_FILE"
              echo "ðŸ“± APK: $APK_NAME" >> "$CHECKSUM_FILE"
              echo "ðŸ“ æ–‡ä»¶å¤§å°: $APK_SIZE" >> "$CHECKSUM_FILE"
              
              # éªŒè¯ APK ç­¾å
              echo "ðŸ” éªŒè¯ APK ç­¾å..."
              if [ -f "$APKSIGNER" ]; then
                if java -jar "$APKSIGNER" verify --verbose "$apk"; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡" >> "$CHECKSUM_FILE"
                else
                  echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥"
                  echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥" >> "$CHECKSUM_FILE"
                fi
              else
                echo "âš ï¸  apksigner æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ jarsigner éªŒè¯..."
                if jarsigner -verify -verbose "$apk" >/dev/null 2>&1; then
                  echo "âœ… APK ç­¾åéªŒè¯æˆåŠŸ (jarsigner)"
                  echo "âœ… ç­¾åçŠ¶æ€: éªŒè¯é€šè¿‡ (jarsigner)" >> "$CHECKSUM_FILE"
                else
                  echo "âŒ APK ç­¾åéªŒè¯å¤±è´¥ (jarsigner)"  
                  echo "âŒ ç­¾åçŠ¶æ€: éªŒè¯å¤±è´¥ (jarsigner)" >> "$CHECKSUM_FILE"
                fi
              fi
              
              # ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç 
              echo ""
              echo "ðŸ“Š ç”Ÿæˆæ–‡ä»¶æ ¡éªŒç ..."
              
              MD5_HASH=$(md5 "$apk" 2>/dev/null | awk '{print $NF}' || md5sum "$apk" | awk '{print $1}')
              SHA1_HASH=$(shasum -a 1 "$apk" | awk '{print $1}')
              SHA256_HASH=$(shasum -a 256 "$apk" | awk '{print $1}')
              
              echo "ðŸ”¹ MD5:    $MD5_HASH"
              echo "ðŸ”¹ SHA1:   $SHA1_HASH" 
              echo "ðŸ”¹ SHA256: $SHA256_HASH"
              
              # å†™å…¥æ ¡éªŒç åˆ°æŠ¥å‘Šæ–‡ä»¶
              echo "ðŸ”¹ MD5:    $MD5_HASH" >> "$CHECKSUM_FILE"
              echo "ðŸ”¹ SHA1:   $SHA1_HASH" >> "$CHECKSUM_FILE"
              echo "ðŸ”¹ SHA256: $SHA256_HASH" >> "$CHECKSUM_FILE"
              
              echo "========================================="
            fi
          done
          
          echo ""
          echo "âœ… æ‰€æœ‰ APK å¤„ç†å®Œæˆ!"
          echo ""
          echo "ðŸ“„ å®Œæ•´æ ¡éªŒç æŠ¥å‘Š:"
          cat "$CHECKSUM_FILE"

      - name: Check GitHub Token Permissions
        run: |
          echo "ðŸ” æ£€æŸ¥ GitHub Token æƒé™..."
          echo "Repository: $GITHUB_REPOSITORY"
          echo "Actor: $GITHUB_ACTOR"  
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Ref: $GITHUB_REF"
          echo "Ref Name: ${{ github.ref_name }}"
          echo "SHA: $GITHUB_SHA"
          
          # æµ‹è¯• API è®¿é—®æƒé™
          echo "ðŸ” æµ‹è¯• GitHub API è®¿é—®æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY" \
               -o /dev/null -s -w "%{http_code}")
          echo "API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… GitHub API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ GitHub API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi
          
          # æµ‹è¯• Releases API æƒé™
          echo "ðŸ” æµ‹è¯• Releases API æƒé™..."
          HTTP_CODE=$(curl -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/$GITHUB_REPOSITORY/releases" \
               -o /dev/null -s -w "%{http_code}")
          echo "Releases API Status Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Releases API è®¿é—®æˆåŠŸ"
          else
            echo "âŒ Releases API è®¿é—®å¤±è´¥ï¼ŒçŠ¶æ€ç : $HTTP_CODE"
          fi

      - name: Prepare Release Files
        working-directory: ./mobile
        run: |
          echo "ðŸ“¦ å‡†å¤‡å‘å¸ƒæ–‡ä»¶..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p ../release-files
          
          # å¤åˆ¶ APK æ–‡ä»¶åˆ°å‘å¸ƒç›®å½•
          cp build/app/outputs/flutter-apk/*.apk ../release-files/
          
          # å¤åˆ¶æ ¡éªŒç æ–‡ä»¶
          cp apk_checksums.txt ../release-files/
          
          # åˆ›å»ºå‘å¸ƒè¯´æ˜Žæ–‡ä»¶
          cat > ../release-files/RELEASE_NOTES.md << EOF
          # Immich Mobile App Release ${{ github.ref_name }}
          
          è¿™æ˜¯ Immich ç§»åŠ¨åº”ç”¨çš„æ­£å¼å‘å¸ƒç‰ˆæœ¬ã€‚
          
          **æ ‡ç­¾ç‰ˆæœ¬**: ${{ github.ref_name }}
          **æž„å»ºæ—¶é—´**: ${{ github.run_id }}
          **æäº¤å“ˆå¸Œ**: ${{ github.sha }}
          **æž„å»ºå¹³å°**: macOS-14
          
          ## ðŸ“± APK æ–‡ä»¶
          
          è¯·ä¸‹è½½é€‚åˆä½ è®¾å¤‡æž¶æž„çš„ APK æ–‡ä»¶ï¼š
          EOF
          
          # åˆ—å‡ºæ‰€æœ‰ APK æ–‡ä»¶å¹¶æ·»åŠ åˆ°å‘å¸ƒè¯´æ˜Ž
          cd ../release-files
          for apk in *.apk; do
            if [ -f "$apk" ]; then
              apk_size=\$(ls -lh "\$apk" | awk '{print \$5}')
              echo "- **\$apk** (\$apk_size)" >> RELEASE_NOTES.md
            fi
          done
          
          cat >> RELEASE_NOTES.md << EOF
          
          ### æž¶æž„è¯´æ˜Ž
          - \`app-release.apk\` - é€šç”¨ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰æž¶æž„ï¼ˆæŽ¨èä¸‹è½½ï¼‰
          - \`app-arm64-v8a-release.apk\` - ARM64 è®¾å¤‡ä¸“ç”¨ï¼ˆçŽ°ä»£ Android è®¾å¤‡ï¼‰
          - \`app-armeabi-v7a-release.apk\` - ARM 32ä½è®¾å¤‡ä¸“ç”¨ï¼ˆè¾ƒè€è®¾å¤‡ï¼‰
          - \`app-x86_64-release.apk\` - x86 64ä½è®¾å¤‡ä¸“ç”¨ï¼ˆæ¨¡æ‹Ÿå™¨æˆ–ç‰¹æ®Šè®¾å¤‡ï¼‰
          
          ## ðŸ” å®‰å…¨éªŒè¯
          
          - ä¸‹è½½ \`apk_checksums.txt\` æ–‡ä»¶éªŒè¯ APK å®Œæ•´æ€§
          - æ‰€æœ‰ APK æ–‡ä»¶å‡å·²ä½¿ç”¨å‘å¸ƒè¯ä¹¦ç­¾åï¼Œç¡®ä¿å®‰å…¨å¯é 
          - æ”¯æŒ MD5ã€SHA1ã€SHA256 å¤šç§æ ¡éªŒç®—æ³•
          
          ## ðŸ“‹ å®‰è£…è¯´æ˜Ž
          
          1. ä¸‹è½½é€‚åˆä½ è®¾å¤‡æž¶æž„çš„ APK æ–‡ä»¶ï¼ˆæŽ¨èä¸‹è½½é€šç”¨ç‰ˆæœ¬ï¼‰
          2. åœ¨ Android è®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…ï¼š
             - è®¾ç½® â†’ å®‰å…¨ â†’ æœªçŸ¥æ¥æºï¼ˆæˆ–åº”ç”¨å®‰è£…æƒé™ï¼‰
          3. ä½¿ç”¨æ–‡ä»¶ç®¡ç†å™¨æ‰“å¼€ä¸‹è½½çš„ APK æ–‡ä»¶è¿›è¡Œå®‰è£…
          4. é¦–æ¬¡å®‰è£…å¯èƒ½éœ€è¦æŽˆäºˆç›¸å…³æƒé™
          
          ## ðŸ”„ æ›´æ–°è¯´æ˜Ž
          
          - å¦‚æžœå·²å®‰è£…æ—§ç‰ˆæœ¬ï¼Œæ–°ç‰ˆæœ¬ä¼šè‡ªåŠ¨è¦†ç›–å®‰è£…
          - å»ºè®®åœ¨å®‰è£…å‰å¤‡ä»½é‡è¦æ•°æ®
          - æ”¯æŒä»Ž Google Play ç‰ˆæœ¬å‡çº§åˆ°æ­¤ç‰ˆæœ¬
          
          ## ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚é‡åˆ°é—®é¢˜ï¼Œè¯·åœ¨ GitHub Issues ä¸­åé¦ˆï¼š
          https://github.com/${{ github.repository }}/issues
          
          ## æºç ä¿¡æ¯
          
          - åŸºäºŽæäº¤: ${{ github.sha }}
          - æž„å»ºåˆ†æ”¯: ${{ github.ref_name }}
          - Flutter ç‰ˆæœ¬: Stable Channel
          - ç­¾åçŠ¶æ€: å·²ç­¾å
          EOF
          
          echo ""
          echo "ðŸ“‹ å‘å¸ƒæ–‡ä»¶åˆ—è¡¨:"
          ls -la ../release-files/
          echo ""
          echo "ðŸ“„ æ–‡ä»¶å¤§å°ç»Ÿè®¡:"
          du -h ../release-files/*

      - name: Debug Release Files
        run: |
          echo "ðŸ” è°ƒè¯•å‘å¸ƒæ–‡ä»¶ä¿¡æ¯..."
          echo "å½“å‰å·¥ä½œç›®å½•: $(pwd)"
          echo "æ ‡ç­¾åç§°: ${{ github.ref_name }}"
          echo "æ˜¯å¦é¢„å‘å¸ƒ: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}"
          
          echo ""
          echo "ðŸ“‹ å‘å¸ƒæ–‡ä»¶è¯¦æƒ…:"
          ls -la release-files/
          
          echo ""
          echo "ðŸ“„ å‘å¸ƒè¯´æ˜Žå†…å®¹é¢„è§ˆ:"
          head -30 release-files/RELEASE_NOTES.md
          
          echo ""
          echo "ðŸ” æ ¡éªŒç æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -20 release-files/apk_checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: "Immich Mobile ${{ github.ref_name }}"
          body_path: release-files/RELEASE_NOTES.md
          files: |
            release-files/*.apk
            release-files/apk_checksums.txt
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          fail_on_unmatched_files: false 